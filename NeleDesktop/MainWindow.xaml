<Window x:Class="NeleDesktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:NeleDesktop.ViewModels"
        xmlns:models="clr-namespace:NeleDesktop.Models"
        Title="Nele Chat" Width="920" Height="600" MinWidth="780" MinHeight="520"
        Background="{DynamicResource WindowBackgroundBrush}"
        FontFamily="Segoe UI Variable"
        Loaded="Window_Loaded"
        SourceInitialized="Window_SourceInitialized"
        Closing="Window_Closing">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0"
                Background="{DynamicResource SidebarBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel Margin="16,16,16,8">
                    <TextBlock Text="Nele AI" FontSize="18" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding StatusMessage}" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap" />
                </StackPanel>

                <TreeView x:Name="ConversationTree"
                          Grid.Row="1"
                          Margin="8,0,8,8"
                          Background="Transparent"
                          BorderThickness="0"
                          AllowDrop="True"
                          SelectedItemChanged="ConversationTree_SelectedItemChanged"
                          PreviewMouseLeftButtonDown="ConversationTree_PreviewMouseLeftButtonDown"
                          PreviewMouseMove="ConversationTree_PreviewMouseMove"
                          Drop="ConversationTree_Drop">
                    <TreeView.Resources>
                        <HierarchicalDataTemplate DataType="{x:Type vm:ChatFolderViewModel}" ItemsSource="{Binding Chats}">
                            <Border Padding="8,6" CornerRadius="8">
                                <Border.ContextMenu>
                                    <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                        <MenuItem Header="Delete folder" Click="DeleteFolder_Click" />
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8B7;" Margin="0,0,6,0" />
                                    <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis" />
                                </StackPanel>
                            </Border>
                        </HierarchicalDataTemplate>

                        <DataTemplate DataType="{x:Type vm:ChatConversationViewModel}">
                            <Border Padding="8,6" CornerRadius="8">
                                <Border.ContextMenu>
                                    <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                        <MenuItem Header="Move to folder..." Click="MoveToFolder_Click" />
                                        <MenuItem Header="Remove from folder" Click="RemoveFromFolder_Click" />
                                        <Separator />
                                        <MenuItem Header="Delete chat" Click="DeleteChat_Click" />
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <TextBlock Text="{Binding Title}" TextTrimming="CharacterEllipsis" />
                            </Border>
                        </DataTemplate>
                    </TreeView.Resources>

                    <TreeView.ItemsSource>
                        <CompositeCollection>
                            <CollectionContainer Collection="{Binding Folders}" />
                            <CollectionContainer Collection="{Binding RootChats}" />
                        </CompositeCollection>
                    </TreeView.ItemsSource>

                    <TreeView.ItemContainerStyle>
                        <Style TargetType="TreeViewItem">
                            <Setter Property="Margin" Value="0,2" />
                            <Setter Property="IsExpanded" Value="True" />
                        </Style>
                    </TreeView.ItemContainerStyle>
                </TreeView>

                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="12,8,12,12">
                    <Button Content="New chat" Command="{Binding NewChatCommand}" Margin="0,0,8,0" />
                    <Button Content="New folder" Command="{Binding NewFolderCommand}" />
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Column="1" Background="{DynamicResource WindowBackgroundBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Padding="16,16,16,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="{Binding SelectedChat.Title}" FontSize="18" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding Settings.SelectedModel}" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}" />
                    </StackPanel>
                    <TextBlock Grid.Column="1"
                               Margin="0,6,12,0"
                               Text="Typing..."
                               Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                               Foreground="{DynamicResource SecondaryTextBrush}" />
                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <Button Command="{Binding ToggleThemeCommand}" Background="Transparent" BorderThickness="0" Padding="6">
                            <TextBlock FontFamily="Segoe MDL2 Assets" FontSize="16">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="&#xE708;" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDarkMode}" Value="False">
                                                <Setter Property="Text" Value="&#xE706;" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Button>
                        <Button Click="OpenSettings_Click" Background="Transparent" BorderThickness="0" Padding="6" Margin="8,0,0,0">
                            <TextBlock FontFamily="Segoe MDL2 Assets" FontSize="16" Text="&#xE713;" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <ScrollViewer x:Name="ChatScrollViewer"
                          Grid.Row="1"
                          Margin="16,0,16,8"
                          VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding ActiveMessages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:ChatMessage}">
                            <StackPanel Margin="0,6"
                                        HorizontalAlignment="{Binding Role, Converter={StaticResource MessageAlignmentConverter}}">
                                <Border Background="{Binding Role, Converter={StaticResource MessageBubbleBrushConverter}}"
                                        CornerRadius="14"
                                        Padding="12"
                                        MaxWidth="520">
                                    <TextBlock Text="{Binding Content}" TextWrapping="Wrap" />
                                </Border>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <Border Grid.Row="2" Margin="16,8,16,16" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="14" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                <Grid Margin="6">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="InputBox"
                             Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                             AcceptsReturn="True"
                             MinHeight="44"
                             VerticalScrollBarVisibility="Auto"
                             TextWrapping="Wrap"
                             BorderThickness="0"
                             Background="Transparent"
                             KeyDown="InputBox_KeyDown" />
                    <Button Grid.Column="1"
                            Margin="8,0,2,0"
                            Content="Send"
                            Command="{Binding SendMessageCommand}" />
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
